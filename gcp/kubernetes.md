# Google Kubernetes Engine
構成ファイルを渡すと勝手に管理してくれる  
ローリングアップデート等も対応。

## 構成
インターネット -> Cluster -> Service -> Pods みたいtな感じ。
ほぼpod = taskみたいな感じで考えて良さそう。ServiceがPodの集合単位 + ロードバランサになっている。  
Clusterは各種マシンタイプ、ノード数、 ネットワークの設定が可能。

## Anthos
ハイブリッド/マルチクラウドを管理するGKE。  
GCPのリソースだけでなく、外部クラウドやオンプレのリソースも管理を一元化できる。

## Tips

### クラスタの設計
#### 可用性が選択できる
 * single zone - 99.5%
   ノードとマスターが一台なので低可用性
 * multi zone - 99.5%
   ノードはマルチゾーンだが、マスターは一台なので低可用性
 * region cluster 99.95%
   ノードとマスターがゾーン間で冗長化

#### GKEのバージョン
1.14.10-GKE36
{クーバネーティスのバージョン}-GKE{GKEのバージョン}

Googleが推奨するバージョンはリリースチャネルで指定できる
種類はrapid, regular, stableで、本番はstableがおすすめ  
自動アップグレードしてくれる。(ただしアップグレードの時間帯の指定や除外はできる)

#### ネットワークモード
* ルートベースクラスタ
  VPCのネットワークから完全に独立する
  カスタムルートの割り当て上限がある
* VPCネイティブクラスタ(推奨)
  サブネットのセカンダリIPをクラスタ内部で利用する
  共有VPCの利用可能
  コンテナネイティブ負荷分散の利用が可能

#### Network Endpoit Groupe
VPCネイティブクラスタでのみ使用可能。ロードバランシングがネットワークとGKEで二重になってしまう問題を解決できる。  

#### デフォルトVPCは使わない
オートでサブネット切っちゃうので、VPC同士でピアリングしたりするとIPがかぶる可能性が高くて微妙。

#### プライベートクラスタ
ノードにプライベートIPのみ付与する。
in - loadbalancer経由
out - cloud nat経由(Private Google Accessを付与するとGCP APIを使用できる)

#### ノードプール
OSはContaier-Optimized OSを推奨

#### サービスアカウント
必要な数だけ付与すること

### クラスタ運用

#### Pod -> GCPサービスの利用
Workload Identityを利用する。  
GCPのサービウアカウントとKubernetesのサービスアカウントと紐付ける

